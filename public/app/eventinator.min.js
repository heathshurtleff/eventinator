angular.module("eventinator",["ui.router","ngResource"]);angular.module("eventinator").config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/");e.state("main",{url:"/",templateUrl:"app/events/eventList.html",controller:"eventinatorCtrl"}).state("signup",{url:"/signup",templateUrl:"app/events/eventSignup.html",controller:"eventSignupCtrl"}).state("create",{url:"/create",templateUrl:"app/events/createEvent.html",controller:"createEventCtrl"})}]);angular.module("eventinator").controller("eventinatorCtrl",["$scope","eventIdentity","authService","$location","eventsService",function(e,t,n,a,r){e.identity=t;r.fetchEvents().then(function(t){e.events=t},function(t){e.eventsFail=t});e.signin=function(e,t){n.authenticateUser(e,t).then(function(e){e||$(".sign-in-error .help-block").css("opacity",1)})};e.signout=function(){n.logoutUser().then(function(){e.emial="";e.password="";a.path("/")})}}]).filter("url",function(){return window.encodeURIComponent});angular.module("eventinator").factory("toastrService",[function(){toastr.options={positionClass:"toast-top-center",preventDuplicates:!0};return{toast:function(e,t){toastr[e](t)}}}]);angular.module("eventinator").directive("endBeforeStart",function(){return{require:"ngModel",link:function(e,t,n,a){a.$validators.endBeforeStart=function(t){if(a.$isEmpty(t))return!0;if(!e.eventStart)return!0;var n=new Date(e.eventStart).getTime(),r=new Date(t).getTime();return r>n}}}}).directive("futureDate",function(){return{require:"ngModel",link:function(e,t,n,a){a.$validators.future=function(e){if(a.$isEmpty(e))return!0;var t=new Date,n=t.getTime(),r=new Date(e).getTime();return r>n}}}});angular.module("eventinator").factory("validationService",[function(){return{checkFieldStatus:function(e,t){var n=e.attr("data-pretty-name"),a=e.attr("data-content");("focus"!==t.type&&e.val().length>0||"jQueryEach"===t.type)&&this.changeValidationIcon(e,e.hasClass("ng-invalid"));e.hasClass("ng-invalid")?e.hasClass("ng-invalid-required")&&!e.hasClass("ng-pristine")?a=n+" is required":e.hasClass("ng-invalid-minlength")?a=n+" must be at least "+e.attr("ng-minlength")+" characters":e.hasClass("ng-invalid-maxlength")?a=n+" must be less than "+e.attr("ng-maxlength")+" characters":e.hasClass("ng-invalid-email")?a="Invalid email address":e.hasClass("ng-invalid-datetimelocal")?a="Invlaid date format":e.hasClass("ng-invalid-future")?a=n+" must be in the future":e.hasClass("ng-invalid-end-before-start")&&(a="Event must start before it ends"):e.hasClass("ng-valid")&&e.val().length>0&&(a="Good to go!");this.updatePopoverText(e,a)},updatePopoverText:function(e,t){var n=e.data("bs.popover");n&&n.tip().find(".popover-content").text(t)},changeValidationIcon:function(e,t){var n=e.parents(".has-feedback"),a=n.find(".form-control-feedback");if(t){n.removeClass("has-success");a.removeClass("glyphicon-ok");n.addClass("has-error");a.addClass("glyphicon-remove")}else{n.removeClass("has-error");a.removeClass("glyphicon-remove");n.addClass("has-success");a.addClass("glyphicon-ok")}}}}]);angular.module("eventinator").factory("addressService",function(){return{autocomplete:null,initAutocomplete:function(e){this.autocomplete=new google.maps.places.Autocomplete(document.getElementById(e),{types:["geocode"]})},geolocate:function(){var e=this;navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(t){var n={lat:t.coords.latitude,lng:t.coords.longitude},a=new google.maps.Circle({center:n,radius:t.coords.accuracy});e.autocomplete.setBounds(a.getBounds())})}}});angular.module("eventinator").factory("authService",["$q","$http","eventUser","eventIdentity",function(e,t,n,a){return{authenticateUser:function(r,o){var i=e.defer();t.post("/app/eventLogin",{username:r,password:o}).then(function(e){if(e.data.success){var t=new n;angular.extend(t,e.data.user);a.currentUser=t;i.resolve(!0)}else i.resolve(!1)});return i.promise},createEvtUser:function(t){var r=new n(t),o=e.defer();r.$save().then(function(){a.currentUser=r;o.resolve()},function(e){o.reject(e.data.excuse)});return o.promise},logoutUser:function(){var n=e.defer();t.post("/app/logout",{logout:!0}).then(function(){a.currentUser=void 0;n.resolve()});return n.promise}}}]);angular.module("eventinator").controller("createEventCtrl",["$scope","$location","addressService","events","validationService","toastrService",function(e,t,n,a,r,o){e.eventHost=e.identity.currentUser.fullName;var i=$("input, textarea");i.on("focus blur keyup change input",function(t){var n=$(this);if("input"===t.type){e.create.eventType.$validate();n.change()}r.checkFieldStatus(n,t)});$("#formSubmit").on("click",function(e){e.preventDefault()});e.eventCreation=function(){var n={title:e.eventTitle,host:e.eventHost,type:e.eventType,start:e.eventStart,end:e.eventEnd,location:e.eventLocation,guests:e.guests,info:e.info},s=new a(n),c=$("#eventCreationForm");c.hasClass("ng-valid")?s.$save().then(function(e){o.toast("success",e.title+" successfully created!");t.path("/")},function(e){$(".full-form-error").text(e.statusText+" | "+e.data.excuse)}):i.each(function(){var e=$(this),t={type:"jQueryEach"};e.removeClass("ng-pristine");r.checkFieldStatus(e,t)})};var s=$("#location");s.on("focus",function(){var t=$(this);n.initAutocomplete(t.attr("id"));n.geolocate();n.autocomplete.addListener("place_changed",function(){e.eventLocation=s.val()})});$(function(){$("[data-toggle=popover]").popover()})}]);angular.module("eventinator").factory("eventIdentity",["$window","eventUser",function(e,t){var n;if(e.bootstrappedEventUser){n=new t;angular.extend(n,e.bootstrappedEventUser)}return{currentUser:n,authenticated:function(){return!!this.currentUser}}}]);angular.module("eventinator").controller("eventSignupCtrl",["$scope","$location","eventUser","authService","addressService","validationService",function(e,t,n,a,r,o){function i(e){var t=e.val(),n={upper:t.search(/[A-Z]/g)>-1,lower:t.search(/[a-z]/g)>-1,num:t.search(/[0-9]/g)>-1,punct:t.search(/[!#$@\?\&\*\_ \.]/g)>-1,chars:t.length>=8,invalidChars:t.search(v)>-1};s(n,e)}function s(e,t){var n=$(".pass-confirm-container"),a=n.find(".requirement-box"),r=$(".pwd-popover").find(".arrow"),i=!1;a.removeClass("valid");r.removeClass("valid");e.upper&&n.find(".upper").addClass("valid");e.lower&&n.find(".lower").addClass("valid");if(e.num){n.find(".num").addClass("valid");r.addClass("valid")}e.punct&&n.find(".punct").addClass("valid");e.chars&&n.find(".chars").addClass("valid");e.upper&&e.lower&&e.num&&e.punct&&e.chars||(i=!0);if(e.invalidChars){i=!0;$(".password-error").text("The password you entered contains an invalid character.")}else $(".password-error").text("");o.changeValidationIcon(t,i)}e.validForm=!0;e.eventSignup=function(){var n={username:e.email,password:e.password,fullName:e.fullName,company:e.company,job:e.job,bday:e.bday,homeAddress:e.homeAddress},r=!1;c.each(function(){var e=$(this);e.hasClass("ng-invalid")&&(r=!0)});r||a.createEvtUser(n).then(function(){t.path("/")},function(e){$(".full-form-error").text(e)})};var c=$('#eventSignUpForm input[id!="password"]'),u=$("#password"),l=$("#confPass"),d=$("#homeAddr"),v=/[^A-z0-9\!\@\#\$\&\*\_ \.\?]/g;u.popover({container:"body",content:'<div class="pass-confirm-container"><div class="requirement-box upper">A</div><div class="requirement-box lower">a</div><div class="requirement-box num">0-9</div><div class="requirement-box punct">!&amp;?</div><div class="requirement-box chars">8+</div></div>',html:!0,placement:"top",trigger:"focus",template:'<div class="popover pwd-popover"><div class="arrow"></div><div class="popover-content"></div></div>'});l.popover({container:"body",content:"Confirm your password",html:!0,placement:"top",trigger:"focus"});$(function(){$("[data-toggle=popover]").popover()});c.on("focus keyup blur",function(e){var t=$(this);o.checkFieldStatus(t,e)});u.on("focus keyup",function(){i($(this))});l.on("focus keyup blur",function(){var t=$(this);o.changeValidationIcon(t,e.password!==e.confPass);e.password!==e.confPass?o.updatePopoverText(t,"You passwords must match"):o.updatePopoverText(t,"We have a match!")});d.on("focus",function(){var t=$(this);r.initAutocomplete(t.attr("id"));r.geolocate();r.autocomplete.addListener("place_changed",function(){e.homeAddress=d.val()})})}]);angular.module("eventinator").factory("eventUser",["$resource",function(e){var t=e("/app/eventUsers/:id",{_id:"@id"},{update:{method:"PUT",isArray:!1}});return t}]);angular.module("eventinator").factory("events",["$resource",function(e){var t=e("app/createEvent/:id",{_id:"@id"},{update:{method:"PUT",isArray:!1}});return t}]);angular.module("eventinator").factory("eventsService",["$q","$http",function(e,t){return{fetchEvents:function(){var n=e.defer();t.get("./app/events").then(function(e){n.resolve(e.data)},function(e){console.log(e)});return n.promise}}}]);